---
apiVersion: v1
kind: ConfigMap
metadata:
  name: github-stats-exporter-config
data:
  config.yaml: |
    server:
      listen_addr: ":8080"
      log_level: "debug"
    metrics:
      topology: "single_service_target"
      scrape_service_dns: "github-stats-exporter-metrics.github-stats-exporter.svc.cluster.local:8080"
    leader_election:
      enabled: true
      namespace: "github-stats-exporter"
      lease_name: "github-stats-exporter-leader"
      lease_duration: "30s"
      renew_deadline: "20s"
      retry_period: "5s"
    github:
      api_base_url: "https://api.github.com"
      request_timeout: "20s"
      unhealthy_failure_threshold: 6
      unhealthy_cooldown: "1m"
      orgs:
        - org: "org-a"
          app_id: 111111
          installation_id: 222222
          private_key_path: "/etc/github-stats-exporter/keys/org-a.pem"
          scrape_interval: "10m"
          repo_allowlist: ["*"]
          per_org_concurrency: 4
    rate_limit:
      min_remaining_threshold: 100
      min_reset_buffer: "10s"
      secondary_limit_backoff: "60s"
    retry:
      max_attempts: 5
      initial_backoff: "2s"
      max_backoff: "90s"
      jitter: true
    loc:
      source: "stats_contributors"
      refresh_interval: "24h"
      fallback_enabled: true
      fallback_max_commits_per_repo_per_week: 250
      fallback_max_commit_detail_calls_per_org_per_hour: 1000
      large_repo_zero_detection_windows: 2
      large_repo_cooldown: "7d"
    backfill:
      enabled: true
      max_message_age: "24h"
      consumer_count: 3
      requeue_delays: ["1m", "5m", "30m", "2h"]
      coalesce_window: "15m"
      dedup_ttl: "12h"
      max_enqueues_per_org_per_minute: 100
    amqp:
      url: "amqp://githubstats:githubstats@rabbitmq.github-stats-exporter.svc.cluster.local:5672/"
      exchange: "gh.backfill"
      queue: "gh.backfill.jobs"
      dlq: "gh.backfill.dlq"
    store:
      backend: "redis"
      redis_mode: "standalone"
      redis_addr: "redis.github-stats-exporter.svc.cluster.local:6379"
      redis_master_set: "mymaster"
      redis_sentinel_addrs: []
      redis_password: ""
      redis_db: 0
      retention: "14d"
      metric_refresh_interval: "30s"
      index_shards: 64
      export_cache_mode: "incremental"
      max_series_budget: 3000000
    health:
      github_probe_interval: "30s"
      github_recover_success_threshold: 2
    telemetry:
      otel_enabled: false
      otel_exporter_otlp_endpoint: ""
      otel_trace_mode: "off"
      otel_trace_sample_ratio: 0.05
