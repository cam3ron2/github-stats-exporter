---
name: Test
on: # yamllint disable-line rule:truthy
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:
permissions:
  contents: read
concurrency:
  group: test-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
env:
  GOCACHE: ${{ github.workspace }}/.gocache
  GOMODCACHE: ${{ github.workspace }}/.gomodcache
jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum
      - name: Run unit tests
        run: env -u GOROOT go test -race -count=1 -timeout 90s ./...
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CI_GITHUB_APP_ORG: ${{ secrets.CI_GITHUB_APP_ORG }}
      CI_GITHUB_APP_ID: ${{ secrets.CI_GITHUB_APP_ID }}
      CI_GITHUB_APP_INSTALLATION_ID: ${{ secrets.CI_GITHUB_APP_INSTALLATION_ID }}
      CI_GITHUB_APP_PRIVATE_KEY: ${{ secrets.CI_GITHUB_APP_PRIVATE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show Docker versions
        run: |
          docker version
          docker compose version
      - name: Prepare CI GitHub App credentials
        run: |
          for value_name in CI_GITHUB_APP_ORG CI_GITHUB_APP_ID CI_GITHUB_APP_INSTALLATION_ID CI_GITHUB_APP_PRIVATE_KEY; do
            if [ -z "${!value_name}" ]; then
              echo "missing required secret: ${value_name}"
              exit 1
            fi
          done

          mkdir -p config/keys
          printf '%s' "${CI_GITHUB_APP_PRIVATE_KEY}" | sed 's/\\n/\n/g' > config/keys/gh-app-key.pem
          chmod 600 config/keys/gh-app-key.pem

          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          source_path = Path("config/local.yaml")
          rendered = source_path.read_text(encoding="utf-8")
          updates = [
              (
                  r'(?m)^(\s*(?:-\s*)?org:\s*).+$',
                  lambda m: f'{m.group(1)}"{os.environ["CI_GITHUB_APP_ORG"]}"',
              ),
              (r'(?m)^(\s*app_id:\s*).+$', lambda m: f'{m.group(1)}{os.environ["CI_GITHUB_APP_ID"]}'),
              (
                  r'(?m)^(\s*installation_id:\s*).+$',
                  lambda m: f'{m.group(1)}{os.environ["CI_GITHUB_APP_INSTALLATION_ID"]}',
              ),
              (r'(?m)^(\s*private_key_path:\s*).+$', lambda m: f'{m.group(1)}"/app/keys/gh-app-key.pem"'),
          ]

          for pattern, build_replacement in updates:
              rendered, count = re.subn(pattern, build_replacement, rendered, count=1)
              if count != 1:
                  raise SystemExit(f"expected to patch one field for pattern: {pattern}")

          Path("config/ci.yaml").write_text(rendered, encoding="utf-8")
          PY
      - name: Start stack
        env:
          GITHUB_STATS_CONFIG_PATH: ./config/ci.yaml
        run: docker compose up -d --build
      - name: Wait for leader and follower readiness
        run: |
          timeout 240 bash -c "until curl -fsS http://localhost:8080/readyz >/dev/null; do sleep 2; done"
          timeout 240 bash -c "until curl -fsS http://localhost:8081/readyz >/dev/null; do sleep 2; done"
      - name: Run compose functional checks
        env:
          GITHUB_STATS_CONFIG_PATH: ./config/ci.yaml
        run: ./scripts/compose-functional-check.sh
      - name: Dump compose logs on failure
        if: failure()
        run: docker compose logs --no-color --tail=400
      - name: Tear down stack
        if: always()
        env:
          GITHUB_STATS_CONFIG_PATH: ./config/ci.yaml
        run: docker compose down -v --remove-orphans
